# docker-compose.yml описывает все контейнеры, которые нужны для работы системы.
# Запуск: docker-compose up -d (поднять всё в фоне)
# Остановка: docker-compose down
# Логи: docker-compose logs -f <имя-сервиса>

services:

  # ==================== ИНФРАСТРУКТУРА ====================

  # Redis — in-memory хранилище, используется Gateway для Rate Limiting
  redis:
    image: redis:7-alpine          # Готовый образ Redis (alpine = маленький Linux)
    ports:
      - "6379:6379"                # host:container — пробрасываем порт наружу
    command: redis-server --requirepass redis_password_2024  # Запуск с паролем

  # Zipkin — UI для просмотра distributed traces
  zipkin:
    image: openzipkin/zipkin       # Готовый образ Zipkin
    ports:
      - "9411:9411"

  # ==================== SPRING CLOUD ИНФРАСТРУКТУРА ====================

  # Config Server — запускается ПЕРВЫМ
  # Раздаёт конфигурацию всем остальным сервисам
  config-server:
    build:
      context: .                   # Контекст сборки — корень проекта (где лежит Dockerfile)
      args:
        SERVICE_NAME: config-server  # Передаём имя модуля в Dockerfile
    ports:
      - "8888:8888"
    environment:
      # Активируем профили: native (читать конфиги из файлов) + docker (пути контейнера)
      SPRING_PROFILES_ACTIVE: native,docker
    volumes:
      # Монтируем папку config-repo с хоста внутрь контейнера
      # Без этого config-server не увидит yml-файлы с конфигурацией
      - ./config-repo:/config-repo
    healthcheck:
      # Docker будет периодически проверять, жив ли сервис
      # Пока healthcheck не пройдёт — зависимые сервисы не запустятся
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health"]
      interval: 10s               # Проверять каждые 10 секунд
      timeout: 5s                 # Таймаут на ответ
      retries: 5                  # Сколько раз попробовать перед тем как считать unhealthy
      start_period: 20s           # Дать сервису время на старт перед первой проверкой

  # Discovery Server (Eureka) — запускается ВТОРЫМ
  # Реестр сервисов: все микросервисы регистрируются здесь
  discovery-server:
    build:
      context: .
      args:
        SERVICE_NAME: discovery-server
    ports:
      - "8761:8761"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      # Discovery-server тоже получает конфигурацию от config-server
      # Переопределяем адрес config-server (вместо localhost)
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-server:8888
    depends_on:
      config-server:
        condition: service_healthy  # Ждём пока config-server РЕАЛЬНО будет готов
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # ==================== МИКРОСЕРВИСЫ ====================

  # API Gateway — точка входа для всех клиентских запросов
  api-gateway:
    build:
      context: .
      args:
        SERVICE_NAME: api-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-server:8888
      # Переопределяем адрес Redis для Gateway (вместо localhost)
      SPRING_DATA_REDIS_HOST: redis
    depends_on:
      discovery-server:
        condition: service_healthy  # Gateway зависит от Eureka
      redis:
        condition: service_started  # И от Redis (для rate limiting)

  # Restaurant Service — управление ресторанами и меню
  restaurant-service:
    build:
      context: .
      args:
        SERVICE_NAME: restaurant-service
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-server:8888
    depends_on:
      discovery-server:
        condition: service_healthy

  # Order Service — управление заказами
  order-service:
    build:
      context: .
      args:
        SERVICE_NAME: order-service
    ports:
      - "8082:8082"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-server:8888
    depends_on:
      discovery-server:
        condition: service_healthy

  # Delivery Service — управление доставкой
  delivery-service:
    build:
      context: .
      args:
        SERVICE_NAME: delivery-service
    ports:
      - "8083:8083"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-server:8888
    depends_on:
      discovery-server:
        condition: service_healthy
